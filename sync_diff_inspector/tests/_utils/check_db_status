#!/bin/bash

# argument 1 is the host
# argument 2 is the port
# argument 3 is the database service's name

for i in {1..20}; do
	# run mysqladmin ping and capture both stdout/stderr
	ping_out=$(mysqladmin ping -h "$1" -P "$2" -u root --ssl-mode=DISABLED 2>&1)
	ping_rc=$?

	# print the ping output so callers can see details
	echo "[mysqladmin ping] attempt=$i host=$1 port=$2 -> $ping_out"

	if [ $ping_rc -eq 0 ]; then
		echo "$3 is alive"
		exit 0
	fi

	echo "$3 is not alive, will try again"
	sleep 2
done

echo "$3 is not alive"
if [ -n "$4" ] && [ -f "$4" ]; then
	echo "--- Contents of $4 ---"
	cat "$4"
fi
exit 2
