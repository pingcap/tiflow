name: Upstream Database Switch

on:
  push:
    branches:
      - test-*
  schedule:
    - cron: '0 17-23 * * *' # run at minute 0 every hour from 01:00 ~ 07:00 UTC+8
  workflow_dispatch:

jobs:
  upstream-database-switch:
    name: upstream-database-switch
    runs-on: ubuntu-20.04

    steps:
      - name: Set up Go env
        uses: actions/setup-go@v3
        with:
          go-version: '1.23'

      - name: Check out code
        uses: actions/checkout@v2

      - name: Cache go modules
        uses: actions/cache@v2
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-ticdc-${{ hashFiles('go.sum') }}

      - name: Cache Tools
        id: cache-tools
        uses: actions/cache@v2
        with:
          path: tools/bin
          key: ${{ runner.os }}-ticdc-tools-${{ hashFiles('tools/check/go.sum') }}

      - name: Build DM binary
        run: make dm_integration_test_build

      - name: Setup containers
        run: |
          docker-compose -f ./dm/tests/upstream_switch/docker-compose.yml up -d

      - name: Run test cases
        run: |
          bash ./dm/tests/upstream_switch/case.sh

      - name: Copy logs to hack permission
        if: ${{ always() }}
        run: |
          mkdir ./logs
          sudo cp -r -L /tmp/dm_test/upstream_switch/master/log ./logs/master
          sudo cp -r -L /tmp/dm_test/upstream_switch/worker1/log ./logs/worker1
          sudo cp -r -L /tmp/dm_test/upstream_switch/worker2/log ./logs/worker2
          sudo chown -R runner ./logs

      # Update logs as artifact seems not stable, so we set `continue-on-error: true` here.
      - name: Upload logs
        continue-on-error: true
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: upstream-switch-logs
          path: |
            ./logs

  upstream-database-switch-mariadb:
    name: upstream-database-switch-mariadb
    runs-on: ubuntu-20.04

    steps:
      - name: Set up Go env
        uses: actions/setup-go@v3
        with:
          go-version: '1.21'

      - name: Check out code
        uses: actions/checkout@v2

      - name: Cache go modules
        uses: actions/cache@v2
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-ticdc-${{ hashFiles('go.sum') }}

      - name: Cache Tools
        id: cache-tools
        uses: actions/cache@v2
        with:
          path: tools/bin
          key: ${{ runner.os }}-ticdc-tools-${{ hashFiles('tools/check/go.sum') }}

      - name: Build DM binary
        run: make dm_integration_test_build

      - name: Setup containers
        run: |
          docker-compose -f ./dm/tests/upstream_switch_mariadb/docker-compose.yml up -d

      - name: Run test cases
        run: |
          bash ./dm/tests/upstream_switch_mariadb/case.sh

      - name: Copy logs to hack permission
        if: ${{ always() }}
        run: |
          mkdir ./logs
          sudo cp -r -L /tmp/dm_test/upstream_switch_mariadb/master/log ./logs/master
          sudo cp -r -L /tmp/dm_test/upstream_switch_mariadb/worker1/log ./logs/worker1
          sudo cp -r -L /tmp/dm_test/upstream_switch_mariadb/worker2/log ./logs/worker2
          sudo chown -R runner ./logs

      # Update logs as artifact seems not stable, so we set `continue-on-error: true` here.
      - name: Upload logs
        continue-on-error: true
        uses: actions/upload-artifact@v2
        if: ${{ always() }}
        with:
          name: upstream-switch-mariadb-logs
          path: |
            ./logs
