#!/bin/bash

# --workdir: work directory

set -e

OUT_DIR=

while [[ ${1} ]]; do
    case "${1}" in
        --workdir)
            OUT_DIR=${2}
            shift
            ;;
        *)
            echo "Unknown parameter: ${1}" >&2
            exit 1
    esac

    if ! shift; then
        echo 'Missing parameter argument.' >&2
        exit 1
    fi
done

CUR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
source $CUR/../_utils/test_prepare

cd $OUT_DIR && echo "start third tidb cluster in $OUT_DIR"

cat - >"$OUT_DIR/pd-config.toml" <<EOF
[replication]
# Set it to 1 to make sure we have enough replicas to run placement-rules.
max-replicas = 1
enable-placement-rules = true
EOF

echo "Starting Third PD..."
pd-server \
    --client-urls http://${THIRD_PD_HOST}:${THIRD_PD_PORT} \
    --peer-urls http://${THIRD_PD_HOST}:${THIRD_PD_PEER_PORT} \
    --config "$OUT_DIR/pd-config.toml" \
    --log-file "$OUT_DIR/pd_third.log" \
    --data-dir "$OUT_DIR/pd_third" &

# wait until PD is online...
while ! curl -o /dev/null -sf http://${THIRD_PD_HOST}:${THIRD_PD_PORT}/pd/api/v1/version; do
    sleep 1
done

while [ -z "$(curl http://${THIRD_PD_HOST}:${THIRD_PD_PORT}/pd/health 2> /dev/null | grep 'health' | grep 'true')" ]; do
    sleep 1
done

# Tries to limit the max number of open files under the system limit
cat - >"$OUT_DIR/tikv-config-third.toml" <<EOF
[rocksdb]
max-open-files = 4096
[raftdb]
max-open-files = 4096
[raftstore]
# true (default value) for high reliability, this can prevent data loss when power failure.
sync-log = false


# [coprocessor]
# region-max-keys = 6000
# region-split-keys = 5000
EOF

# tidb server config file
cat - >"$OUT_DIR/tidb-config-third.toml" <<EOF
split-table = true
[experimental]
allow-auto-random = true
EOF

echo "Starting Third TiKV..."
tikv-server \
    --pd ${THIRD_PD_HOST}:${THIRD_PD_PORT} \
    -A ${THIRD_TIKV_HOST}:${THIRD_TIKV_PORT} \
    --status-addr ${THIRD_TIKV_HOST}:${THIRD_TIKV_STATUS_PORT} \
    --log-file "$OUT_DIR/tikv_third.log" \
    --log-level debug \
    -C "$OUT_DIR/tikv-config-third.toml" \
    -s "$OUT_DIR/tikv_third" &

sleep 2

echo "Starting Third TiDB..."
tidb-server \
    -P ${THIRD_TIDB_PORT} \
    -config "$OUT_DIR/tidb-config-third.toml" \
    --store tikv \
    --path ${THIRD_PD_HOST}:${THIRD_PD_PORT} \
    --status=${THIRD_TIDB_STATUS} \
    --log-file "$OUT_DIR/tidb_thrid.log" &

echo "Verifying Third TiDB is started..."
i=0
while ! mysql -uroot -h${THIRD_TIDB_HOST} -P${THIRD_TIDB_PORT} --default-character-set utf8mb4 -e 'select * from mysql.tidb;'; do
    i=$((i + 1))
    if [ "$i" -gt 60 ]; then
        echo 'Failed to start upstream TiDB'
        exit 2
    fi
    sleep 2
done

run_sql "update mysql.tidb set variable_value='60m' where variable_name='tikv_gc_life_time';" ${THIRD_TIDB_HOST} ${THIRD_TIDB_PORT}
